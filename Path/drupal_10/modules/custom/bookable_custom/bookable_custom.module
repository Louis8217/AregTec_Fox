<?php
use Drupal\Core\Form\FormStateInterface;

/**
 * Hook d'initialisation pour vÃ©rifier si le module est bien chargÃ©.
 */
function bookable_custom_init() {
  \Drupal::logger('bookable_custom')->debug('ðŸš€ bookable_custom.module chargÃ© avec succÃ¨s');
}
bookable_custom_init();

/**
 * Modifie le formulaire de rÃ©servation pour forcer 2 crÃ©neaux pour un cheval.
 */
function bookable_custom_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  \Drupal::logger('bookable_custom')->debug('ðŸ“ hook_form_alter exÃ©cutÃ© pour : @form_id', [
    '@form_id' => $form_id,
  ]);

  if ($form_id == 'booking_contact_add_form' || $form_id == 'bookable_calendar_booking_form') {
    \Drupal::logger('bookable_custom')->info('âœ… Modification du formulaire de rÃ©servation appliquÃ©e.');
    $form['#validate'][] = 'bookable_custom_validate_booking';
  }
}

/**
 * Valide la rÃ©servation en fonction du type d'animal et rÃ©serve le second crÃ©neau.
 */
function bookable_custom_validate_booking($form, FormStateInterface &$form_state) {
    \Drupal::logger('bookable_custom')->debug('ðŸš€ Validation de rÃ©servation exÃ©cutÃ©e.');

    $type_animal = $form_state->getValue('field_animal')[0]['value'] ?? null;
    \Drupal::logger('bookable_custom')->debug('ðŸ“¢ Type d\'animal reÃ§u : @animal', [
        '@animal' => $type_animal,
    ]);

    $date_value = $form_state->getValue('date__value');

    if (!$date_value) {
        \Drupal::logger('bookable_custom')->warning('âš ï¸ `date__value` est null. Tentative de rÃ©cupÃ©ration alternative via booking_instance.');

        $booking_instance_id = $form_state->getValue(['booking_instance', 0, 'target_id']);
        if ($booking_instance_id) {
            $date_value = \Drupal::database()->select('bookable_calendar_opening_inst', 'bco')
                ->fields('bco', ['date__value'])
                ->condition('bco.id', $booking_instance_id)
                ->execute()
                ->fetchField();
        }
    }

    if (!$date_value) {
        \Drupal::logger('bookable_custom')->error('âŒ Impossible de rÃ©cupÃ©rer `date__value`. Annulation.');
        $form_state->setErrorByName('date__value', t("Erreur : Impossible de rÃ©cupÃ©rer la date de dÃ©but."));
        return;
    }

    $date_value = is_numeric($date_value) ? (int) $date_value : strtotime($date_value);
    $next_slot = $date_value + 3600;

    \Drupal::logger('bookable_custom')->debug('ðŸŽ CrÃ©neau validÃ© - DÃ©but: @start | Suivant: @next', [
        '@start' => date('H:i', $date_value),
        '@next' => date('H:i', $next_slot),
    ]);

    $next_instance_id = bookable_custom_find_next_slot($next_slot);

    if (!$next_instance_id || !bookable_custom_check_availability($next_instance_id)) {
        \Drupal::logger('bookable_custom')->warning('ðŸš« CrÃ©neau suivant non disponible - RÃ©servation refusÃ©e.');
        $form_state->setErrorByName('date__value', t("Le crÃ©neau suivant est dÃ©jÃ  rÃ©servÃ© ou indisponible."));
        return;
    }

    \Drupal::logger('bookable_custom')->info('âœ… CrÃ©neau suivant libre, rÃ©servation en cours.');

    // RÃ©server le second crÃ©neau immÃ©diatement
    bookable_custom_reserve_slot($next_instance_id, $form_state->getValues());

    // Mettre Ã  jour la disponibilitÃ© immÃ©diatement
    bookable_custom_update_slot_availability($next_instance_id);
}

/**
 * Trouve l'ID du crÃ©neau suivant basÃ© sur le timestamp.
 */
function bookable_custom_find_next_slot($timestamp) {
    $next_instance_id = \Drupal::database()->select('bookable_calendar_opening_inst', 'bco')
        ->fields('bco', ['id'])
        ->condition('bco.date__value', $timestamp, '=')
        ->execute()
        ->fetchField();

    \Drupal::logger('bookable_custom')->debug('ðŸ“Œ CrÃ©neau suivant ID: @id trouvÃ© pour @time', [
        '@id' => $next_instance_id,
        '@time' => date('H:i', $timestamp),
    ]);

    return $next_instance_id;
}

/**
 * VÃ©rifie si un crÃ©neau est disponible.
 */
function bookable_custom_check_availability($next_instance_id) {
    \Drupal::logger('bookable_custom')->debug('ðŸ” VÃ©rification de la disponibilitÃ© pour ID: @id', [
        '@id' => $next_instance_id,
    ]);

    $reserved = \Drupal::database()->select('booking_contact', 'bc')
        ->fields('bc', ['id'])
        ->condition('bc.booking_instance', $next_instance_id)
        ->execute()
        ->fetchField();

    return !$reserved;
}

/**
 * RÃ©serve automatiquement un crÃ©neau supplÃ©mentaire.
 */
function bookable_custom_reserve_slot($next_instance_id, $values) {
    \Drupal::logger('bookable_custom')->info('ðŸ“ Tentative de rÃ©servation automatique du second crÃ©neau ID: @id.', [
        '@id' => $next_instance_id,
    ]);

    $contact_id = $values['user_id'] ?? 0;

    if ($contact_id === 0) {
        \Drupal::logger('bookable_custom')->error('âŒ Impossible de rÃ©cupÃ©rer l\'ID utilisateur, annulation de la rÃ©servation.');
        return;
    }

    $uuid_service = \Drupal::service('uuid');
    $uuid = $uuid_service->generate();

    \Drupal::database()->insert('booking_contact')
        ->fields([
            'uuid' => $uuid,
            'booking_instance' => $next_instance_id,
            'uid' => $contact_id,
            'party_size' => 1,
        ])
        ->execute();

    \Drupal::logger('bookable_custom')->info('âœ… Second crÃ©neau rÃ©servÃ© automatiquement - ID: @id pour user_id: @user.', [
        '@id' => $next_instance_id,
        '@user' => $contact_id,
    ]);
}

/**
 * Met Ã  jour la disponibilitÃ© du slot aprÃ¨s rÃ©servation.
 */
function bookable_custom_update_slot_availability($instance_id) {
    \Drupal::logger('bookable_custom')->info('ðŸ”„ Mise Ã  jour de la disponibilitÃ© du crÃ©neau ID: @id', [
        '@id' => $instance_id,
    ]);

    $slots = \Drupal::database()->select('bookable_calendar_opening_inst', 'bco')
        ->fields('bco', ['slots'])
        ->condition('bco.id', $instance_id)
        ->execute()
        ->fetchField();

    if ($slots > 0) {
        \Drupal::database()->update('bookable_calendar_opening_inst')
            ->fields(['slots' => $slots - 1])
            ->condition('id', $instance_id)
            ->execute();

        \Drupal::logger('bookable_custom')->info('âœ… CrÃ©neau mis Ã  jour - Slots restants: @slots', [
            '@slots' => $slots - 1,
        ]);
    }
}
